<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Universal RPG</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; text-align: center; }
    h1 { color: #4caf50; }
    .menu, .battle, .shop { display: none; margin-top: 20px; }
    /* üéØ Wyb√≥r cel√≥w ataku */
#targetSelect {
  margin: 15px auto;
  padding: 10px;
  background: #1b1b1b;
  border: 2px solid #4caf50;
  border-radius: 12px;
  width: 70%;
  color: #eee;
}

.target-row {
  margin: 8px 0;
  padding: 8px;
  background: #222;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.target-row b {
  color: #4caf50;
}

.target-select {
  padding: 4px 8px;
  background: #333;
  border: 1px solid #4caf50;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
}

.target-select:hover {
  background: #4caf50;
  color: #000;
}
    .card { border: 2px solid #4caf50; border-radius: 12px; padding: 10px; margin: 10px; display: inline-block; background: #222; width: 170px; }
    button { padding: 8px 15px; margin: 5px; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { opacity: 0.8; }
    .green { background: #4caf50; color: #fff; }
    .red { background: #f44336; color: #fff; }
    .blue { background: #2196f3; color: #fff; }
  </style>
</head>
<body>
  <h1>Universal RPG</h1>
  
<div id="mainMenu">
  <p>Wybierz do 3 postaci</p>
  <div id="characterSelect"></div>

  <h3>Twoja dru≈ºyna:</h3>
  <div id="teamDisplay"></div>

  <p>üíµ <span id="mainMoney">0</span></p>
  <button class="green" onclick="startGame()">Start Gry</button>
  <button class="blue" onclick="openShop()">Sklep</button>
  <button class="red" onclick="resetGame()">Reset gry</button>
</div>

<div id="mapSelect" style="display:none; margin-top:20px;">
  <h2>Wybierz planszƒô</h2>
  <div id="mapOptions" style="display:flex; gap:20px; justify-content:center;"></div>
  <button class="red" onclick="cancelMapSelect()">Anuluj</button>
</div>
 
<div class="battle" id="battleScreen">
  <h2>Poziom <span id="levelNum"></span></h2>
  <div id="playerStats"></div>
  <div id="enemyStats"></div>
  <div id="targetSelect"></div>
  <button class="green" onclick="attack()">Atakuj</button>
  <div id="battleLog"></div>
</div>
  
  <div class="shop" id="shopScreen">
    <h2>Sklep</h2>
    <div id="shopOffer"></div>
    <div id="shopItems"></div>
    <p>üíµ <span id="money">0</span></p>    
    <button class="blue" onclick="closeShop()">Powr√≥t</button>
  </div>
  
  <audio id="attackSound" src="attack.mp3"></
    audio>
  
  <script>
    const baseCharacters = [
      { name: "Dawid", atk: 3, hp: 20 }
    ];

const enemies = [
  { name: "Stickman", atk: 1, hp: 10 },
  { name: "Mutant Stickman", atk: 2, hp: 20 },
  { name: "Titan Stickman", atk: 3, hp: 30 },
  { name: "Astro Mutant Stickman", atk: 6, hp: 22 },
  { name: "Spider Stick", atk: 4, hp: 12 },
  { name: "Stick bird", atk: 2, hp: 10 },
  { name: "Armor Stickman", atk: 1, hp: 15 },
  { name: "Police Stickman", atk: 4, hp: 12 },
  { name: "Glitch Stickman", atk: 3, hp: 24 },
  { name: "Skeleton Stickman", atk: 2, hp: 12 },
  { name: "Zombie Stickman", atk: 2, hp: 16 },
  { name: "Wizard Stickman", atk: 3, hp: 26, heal: 1 },
  { name: "Mega Armor Stickman", atk: 1, hp: 20 },
  { name: "Mroowkens", atk: 4, hp: 40, boss: true },
  { name: "Arquel", hp: 100, attack: 5, boss: true }
];

const shopCharacters = [
  { name: "Adam", cost: 138, atk: 6, hp: 30 },
  { name: "B≈Ça≈ºej", cost: 320, atk: 8, hp: 40 },
  { name: "Czarek", cost: 320, atk: 8, hp: 40 },
  { name: "Damianek", cost: 72, atk: 4, hp: 18 },
  { name: "Dorian", cost: 66, atk: 3, hp: 22 },
  { name: "Ewa1", cost: 192, atk: 8, hp: 24 },
  { name: "Ewa2", cost: 67, atk: 3, hp: 22, heal: 1 },
  { name: "Filip", cost: 85, atk: 5, hp: 17 },
  { name: "Gabriel", cost: 140, atk: 7, hp: 20 },
  { name: "Gabrysia", cost: 44, atk: 2, hp: 22 },
  { name: "Janek", cost: 105, atk: 5, hp: 21 },
  { name: "Julka", cost: 67, atk: 1, hp: 37, heal: 3 },
  { name: "Jurek", cost: 160, atk: 4, hp: 40 },
  { name: "Kacper1", cost: 100, atk: 5, hp: 20 },
  { name: "Kacper2", cost: 80, atk: 4, hp: 20 },
  { name: "Kacper3", cost: 160, atk: 8, hp: 20 },
  { name: "Karol", cost: 104, atk: 4, hp: 26 },
  { name: "Ksawery", cost: 85, atk: 5, hp: 17 },
  { name: "Kuba1", cost: 240, atk: 6, hp: 40 },
  { name: "Kuba2", cost: 104, atk: 4, hp: 26 },
  { name: "Kuba3", cost: 120, atk: 6, hp: 20 },
  { name: "Lena1", cost: 84, atk: 7, hp: 12 },
  { name: "Lena2", cost: 82, atk: 2, hp: 40, heal: 2 },
  { name: "≈Åukasz", cost: 90, atk: 6, hp: 15 },
  { name: "Maciej", cost: 200, atk: 5, hp: 40 },
  { name: "Maciek", cost: 80, atk: 4, hp: 20 },
  { name: "Miko≈Çaj", cost: 80, atk: 4, hp: 20 },
  { name: "Milena", cost: 196, atk: 7, hp: 28 },
  { name: "Natalka", cost: 47, atk: 2, hp: 23, heal: 1 },
  { name: "Natan", cost: 63, atk: 3, hp: 21 },
  { name: "Nataniel", cost: 400, atk: 10, hp: 40 },
  { name: "Nikola", cost: 203, atk: 7, hp: 29 },
  { name: "Ola", cost: 58, atk: 4, hp: 12, stun: { duration: 2, cooldown: 5, lastUsed: -5 } },
  { name: "Oli", cost: 99, atk: 3, hp: 33 },
  { name: "Oliwia", cost: 140, atk: 7, hp: 20 },
  { name: "Oliwier", cost: 240, atk: 8, hp: 30 },
  { name: "Oskar", cost: 45, atk: 2, hp: 22, heal: 1 },
  { name: "Oski", cost: 198, atk: 9, hp: 22 },
  { name: "Piotrek", cost: 320, atk: 8, hp: 40 },
  { name: "Radek", cost: 240, atk: 8, hp: 30 },
  { name: "Rosti", cost: 60, atk: 3, hp: 20 },
  { name: "Roxana", cost: 80, atk: 2, hp: 40 },
  { name: "S≈Çawek", cost: 138, atk: 6, hp: 30 },
  { name: "Sta≈õ", cost: 72, atk: 4, hp: 18 },
  { name: "Sylwia", cost: 96, atk: 4, hp: 24 },
  { name: "Szymon", cost: 60, atk: 2, hp: 30 },
  { name: "Wiktoria", cost: 252, atk: 9, hp: 28 },
  { name: "Wojtek", cost: 125, atk: 5, hp: 25 },
  { name: "Xantia", cost: 42, atk: 2, hp: 20, heal: 2 },
  { name: "Zuzia", cost: 162, atk: 8, hp: 19, stun: { duration: 2, cooldown: 5, lastUsed: -5 } }
];

// üì¶ Itemy (dodajƒÖ statystyki)
const shopItems = [
  // istniejƒÖce
  { name: "Kryszta≈Çowy miecz", cost: 800, target: "Dorian", bonus: { atk: 4 } },
  { name: "Pluszak", cost: 300, target: "Natalka", bonus: { heal: 1 } },
  { name: "Sk√≥rzana Zbroja", cost: 500, target: "≈Åukasz", bonus: { hp: 5 } },
  { name: "Kamienny Sztylet", cost: 600, target: "Dawid", bonus: { atk: 3 } },
  { name: "Mityczna Tarcza", cost: 800, target: "≈Åukasz", bonus: { hp: 8 } },
  { name: "Amulet Mocy", cost: 1200, target: "Dorian", bonus: { atk: 6 } },
  { name: "Eliksir ≈ªycia", cost: 600, target: "Natalka", bonus: { heal: 2 } },
  { name: "Zbroja Smoka", cost: 1000, target: "Dawid", bonus: { hp: 10 } },
  { name: "Sztylet Cienia", cost: 600, target: "Nataniel", bonus: { atk: 3 } },
  { name: "Pier≈õcie≈Ñ Leczenia", cost: 300, target: "Natalka", bonus: { heal: 1 } },
  { name: "He≈Çm Bohatera", cost: 400, target: "Oliwier", bonus: { hp: 4 } },
  { name: "M≈Çot Wojownika", cost: 1000, target: "Max", bonus: { atk: 5 } },
  { name: "Peleryna Cienia", cost: 600, target: "Lena1", bonus: { hp: 6 } },
  { name: "Mikstura Regeneracji", cost: 600, target: "Dawid", bonus: { heal: 2 } },
  { name: "Amulet ≈öniegu", cost: 600, target: "Rosti", bonus: { hp: 4, atk: 1 } },
  { name: "Sztylet Zdrady", cost: 200, target: "Kacper3", bonus: { atk: 1 } },
  { name: "Pier≈õcie≈Ñ Ochrony", cost: 800, target: "Lena1", bonus: { hp: 8 } },
  { name: "He≈Çm Wojownika", cost: 500, target: "Max", bonus: { hp: 5 } },
  { name: "Koszula Lecznicza", cost: 300, target: "Ewa2", bonus: { heal: 1 } },
  { name: "Zbroja z tost√≥w", cost: 400, target: "Rosti", bonus: { hp: 4 } },
  { name: "Tarcza Smoczego Oddechu", cost: 1000, target: "Kacper1", bonus: { hp: 10 } },
  { name: "Miecz Ognia", cost: 400, target: "Dawid", bonus: { atk: 2 } }
];

// üé® Skiny (zmieniajƒÖ wyglƒÖd)
const shopSkins = [
  { name: "Claasic Dawid", cost: 100, target: "Dawid", file: "dawid_skin01.png" },
  { name: "Claasic Natalka", cost: 100, target: "Natalka", file: "natalka_skin01.png" },
  { name: "Claasic Rosti", cost: 100, target: "Rosti", file: "rosti_skin01.png" },
  { name: "Claasic Ksawery", cost: 100, target: "Ksawery", file: "ksawery_skin01.png" },
  { name: "Claasic Gabrysia", cost: 100, target: "Gabrysia", file: "gabrysia_skin01.png" },
  { name: "Claasic Milena", cost: 100, target: "Milena", file: "milena_skin01.png" },
  { name: "Claasic Karol", cost: 100, target: "Karol", file: "karol_skin01.png" }
];

const maps = [
  { name: "Minecraft", file: "map_minecraft.png" },
  { name: "FNaF", file: "map_fnaf.png" },
  { name: "Klasik", file: "map_default.png" }
];

let selectedMap = null;
let boughtItems = [];       
let boughtSkins = {}; 

let shopOfferChar;         
let shopOfferItem;          
let shopOfferSkin;        

let teamSlots = 3;           
let slotUpgradeCost = 200;  
let currentEnemy;
let currentLevel = 0;
let money = 0;
let shopOffer;
let skins = {};

let availableCharacters = [...baseCharacters]; 
let playerTeam = [];

function saveGame() {
  localStorage.setItem("playerTeam", JSON.stringify(playerTeam));
  localStorage.setItem("availableCharacters", JSON.stringify(availableCharacters));
  localStorage.setItem("money", money);
  localStorage.setItem("currentLevel", currentLevel);
  localStorage.setItem("skins", JSON.stringify(skins));
  localStorage.setItem("teamSlots", teamSlots);         // liczba slot√≥w w dru≈ºynie
  localStorage.setItem("slotUpgradeCost", slotUpgradeCost); // koszt nastƒôpnego slotu
}

function loadGame() {
  const savedTeam = localStorage.getItem("playerTeam");
  const savedAvailable = localStorage.getItem("availableCharacters");
  const savedMoney = localStorage.getItem("money");
  const savedLevel = localStorage.getItem("currentLevel");
  const savedSkins = localStorage.getItem("skins");
  const savedTeamSlots = localStorage.getItem("teamSlots");
  const savedSlotCost = localStorage.getItem("slotUpgradeCost");

  if (savedSkins) skins = JSON.parse(savedSkins);

  if (savedAvailable) {
    availableCharacters = JSON.parse(savedAvailable);
  } else {
    availableCharacters = [...baseCharacters]; // domy≈õlnie Dawid
  }

  if (savedTeam) playerTeam = JSON.parse(savedTeam);
  if (savedMoney) money = parseInt(savedMoney);
  if (savedLevel) currentLevel = parseInt(savedLevel);
  if (savedTeamSlots) teamSlots = parseInt(savedTeamSlots);
  if (savedSlotCost) slotUpgradeCost = parseInt(savedSlotCost);

  document.getElementById("money").innerText = money;
  document.getElementById("mainMoney").innerText = money;
}

function buyTeamSlot() {
  if (money < slotUpgradeCost) {
    alert(`Za ma≈Ço üíµ! Potrzebujesz ${slotUpgradeCost} üíµ.`);
    return;
  }

  money -= slotUpgradeCost;  
  teamSlots += 1;          
  slotUpgradeCost += 200;   

  alert(`Nowy slot w dru≈ºynie odblokowany! Masz teraz ${teamSlots} slot√≥w.`);

  // Zaktualizuj wy≈õwietlane pieniƒÖdze i przycisk
  document.getElementById("money").innerText = money;
  renderShop();
  saveGame();
}

function init() {
  const selectDiv = document.getElementById("characterSelect");
  selectDiv.innerHTML = "";
  
  baseCharacters.forEach((ch, i) => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <b>${ch.name}</b><br>
      Atak: ${ch.atk}<br>
      HP: ${ch.hp}<br>
      <button class='green' onclick='chooseCharacter(${i})'>Wybierz</button>`;
    selectDiv.appendChild(div);
  });

  updateShop();
  loadGame();
  renderTeam();
}

function renderTargetSelect() {
  const div = document.getElementById("targetSelect");
  div.innerHTML = "<h3>üéØ Wybierz cele ataku</h3>";

  if (!playerTeam || playerTeam.length === 0 || !currentEnemies || currentEnemies.length === 0) {
    div.innerHTML += "<p>(Brak wyboru ‚Äì walka nie trwa)</p>";
    return;
  }

  playerTeam.forEach((p, i) => {
    let row = document.createElement("div");
    row.className = "target-row";

    let label = document.createElement("span");
    label.innerHTML = `<b>${p.name}</b> atakuje: `;

    let select = document.createElement("select");
    select.className = "target-select";
    select.id = `target-${i}`;

    currentEnemies.forEach((e, j) => {
      let opt = document.createElement("option");
      opt.value = j;
      opt.text = `${e.name} (‚ù§Ô∏è${e.hp})`;
      select.appendChild(opt);
    });

    row.appendChild(label);
    row.appendChild(select);
    div.appendChild(row);
  });
}

function renderTeam() {
  const teamDiv = document.getElementById("teamDisplay");
  teamDiv.innerHTML = "";

  playerTeam = playerTeam || [];
  availableCharacters = availableCharacters || [];
  skins = skins || {};

  // Dru≈ºyna gracza
  if (playerTeam.length === 0) {
    teamDiv.innerHTML = "<p>(Brak postaci w dru≈ºynie)</p>";
  } else {
    playerTeam.forEach((p, index) => {
      const div = document.createElement("div");
      div.className = "card";

      let skinFile = (skins[p.name] && skins[p.name].length > 0) ? skins[p.name][0] : null;

      div.innerHTML = `
        <b>${p.name || "Nieznana"}</b><br>
        ${skinFile ? `<img src="${skinFile}" width="100"><br>` : ""}
        Atak: ${p.atk || 0}<br>
        HP: ${p.hp || 0}<br>
        <button onclick="removeFromTeam(${index})">Usu≈Ñ</button>
      `;
      teamDiv.appendChild(div);
    });
  }

  // Dostƒôpne postacie
  const selectDiv = document.getElementById("characterSelect");
  selectDiv.innerHTML = "<h3>Dostƒôpne postacie</h3>";

  availableCharacters.forEach((ch) => {
    if (!playerTeam.some(p => p.name === ch.name)) { // bezpieczniejsze ni≈º find
      const div = document.createElement("div");
      div.className = "card";

      let skinFile = (skins[ch.name] && skins[ch.name].length > 0) ? skins[ch.name][0] : null;

      div.innerHTML = `
        <b>${ch.name || "Nieznana"}</b><br>
        ${skinFile ? `<img src="${skinFile}" width="100"><br>` : ""}
        Atak: ${ch.atk || 0}<br>
        HP: ${ch.hp || 0}<br>
        <button class='green' onclick='addToTeam("${ch.name}")'>Za≈Ç√≥≈º</button>
      `;
      selectDiv.appendChild(div);
    }
  });
}

function addToTeam(name) {
  if (playerTeam.length >= teamSlots) {
    alert(`Nie mo≈ºesz dodaƒá wiƒôcej postaci! Kup slot w sklepie.`);
    return;
  }
  // znajd≈∫ postaƒá w availableCharacters po nazwie
  let char = availableCharacters.find(c => c.name === name);
  if (char) {
    playerTeam.push(enhanceCharacter(char));
    saveGame();
    renderTeam();
  }
}

function removeFromTeam(i) {
  playerTeam.splice(i, 1);
  saveGame();
  renderTeam();
}

function removeCharacter(index) {
  const removed = playerTeam.splice(index, 1)[0];
  alert(`${removed.name} zosta≈Ç usuniƒôty z dru≈ºyny.`);
  saveGame();
  renderTeam();
}

function chooseCharacter(i) {
  if (playerTeam.length < 3) {
    playerTeam.push(enhanceCharacter(baseCharacters[i]));
    alert(`${baseCharacters[i].name} dodany do dru≈ºyny!`);
    saveGame();
    renderTeam();
  } else {
    alert("Masz ju≈º 3 postacie!");
  }
}

function startGame() {
  if (playerTeam.length === 0) {
    alert("Wybierz chocia≈º jednƒÖ postaƒá!");
    return;
  }
  document.getElementById("mainMenu").style.display = "none";
  document.getElementById("mapSelect").style.display = "block";
  renderMapOptions();
}

function startLevel(level) {
  let numExtraEnemies = 0;

  // Od 25 poziomu i co 25 poziom√≥w ro≈õnie liczba dodatkowych przeciwnik√≥w
  if (level + 1 >= 25) {
    numExtraEnemies = Math.floor((level + 1) / 25);
  }

  let enemiesThisLevel = [];

  // Co 100 poziom√≥w ‚Üí Boss Arquel
  if ((level + 1) % 100 === 0) {
    enemiesThisLevel.push({ name: "Arquel", hp: 100, atk: 5, boss: true });
  }
  // Co 10 poziom√≥w ‚Üí Nroowkens
  else if ((level + 1) % 10 === 0) {
    enemiesThisLevel.push({ ...enemies.find(e => e.boss) });
  } 
  // Normalny przeciwnik
  else {
    const normalEnemies = enemies.filter(e => !e.boss);
    enemiesThisLevel.push({ ...normalEnemies[Math.floor(Math.random() * normalEnemies.length)] });
  }

  // Dodaj dodatkowych przeciwnik√≥w co 25 poziom√≥w
  const normalEnemies = enemies.filter(e => !e.boss);
  for (let i = 0; i < numExtraEnemies; i++) {
    enemiesThisLevel.push({ ...normalEnemies[Math.floor(Math.random() * normalEnemies.length)] });
  }

  currentEnemies = enemiesThisLevel;

  document.getElementById("battleScreen").style.display = "block";
  document.getElementById("levelNum").innerText = level + 1;
  document.getElementById("battleLog").innerHTML = "";
  resetTeamHp();
  renderStats();
  renderTargetSelect();
}

function resetTeamHp() {
  playerTeam.forEach(p => p.hp = p.baseHp);
}

function enhanceCharacter(ch) {
  return { ...ch, hp: ch.hp, baseHp: ch.hp };
}

function renderStats() {
  document.getElementById("playerStats").innerHTML =
    "<h3>Dru≈ºyna</h3>" +
    playerTeam.map(p => `${p.name}: ‚ù§Ô∏è ${p.hp} | ‚öîÔ∏è ${p.atk}${p.heal ? ` | üíö Heal: ${p.heal}` : ""}${p.stun ? " | ‚ö° Stun" : ""}`).join("<br>");

  document.getElementById("enemyStats").innerHTML =
    "<h3>Przeciwnicy</h3>" +
    currentEnemies.map(e => `${e.name}: ‚ù§Ô∏è ${e.hp} | ‚öîÔ∏è ${e.atk}${e.heal ? ` | üíö Heal: ${e.heal}` : ""}${e.stunned ? " | ‚ö° Og≈Çuszony" : ""}`).join("<br>");
}

function attack() {
    if (!currentEnemies || currentEnemies.length === 0) return;

    // Odtwarzanie d≈∫wiƒôku przy ataku gracza
    const sound = document.getElementById('attackSound');
    if (sound) sound.play();

    // --- Tura graczy ---
    playerTeam.forEach((p, i) => {
        let targetIndex = parseInt(document.getElementById(`target-${i}`)?.value);
        let enemy = currentEnemies[targetIndex] || currentEnemies[Math.floor(Math.random() * currentEnemies.length)];
        if (!enemy) return;

        // Stun
        if (p.stun) {
            if ((currentLevel - (p.stun.lastUsed || -p.stun.cooldown)) >= p.stun.cooldown) {
                enemy.stunned = p.stun.duration;
                p.stun.lastUsed = currentLevel;
                log(`${p.name} og≈Çusza ${enemy.name} na ${p.stun.duration} tury!`);
            }
        }

        // Multiattack
        if (p.multiAttack) {
            for (let j = 0; j < p.multiAttack; j++) {
                let multiTarget = currentEnemies[Math.floor(Math.random() * currentEnemies.length)];
                if (multiTarget) {
                    multiTarget.hp -= p.atk;
                    if (multiTarget.hp < 0) multiTarget.hp = 0;
                    log(`${p.name} atakuje ${multiTarget.name} za ${p.atk}!`);
                }
            }
        } else {
            // Normalny atak
            enemy.hp = (Number(enemy.hp) || 0) - (Number(p.atk) || 0);
            if (enemy.hp < 0) enemy.hp = 0;
            log(`${p.name} atakuje ${enemy.name} za ${p.atk}!`);
        }
    });

    // Leczenie
    ["Natalka", "Xantia", "Ewa2", "Julka", "Osksr", "Lena2"].forEach(name => {
        const healer = playerTeam.find(p => p.name === name);
        if (healer) {
            let ally = playerTeam[Math.floor(Math.random() * playerTeam.length)];
            ally.hp = (Number(ally.hp) || 0) + (Number(healer.heal) || 0);
            log(`${healer.name} uleczy≈Ça ${ally.name} o ${healer.heal} HP!`);
        }
    });

    // --- Sprawdzenie wygranej ---
    currentEnemies = currentEnemies.filter(e => e.hp > 0);
    if (currentEnemies.length === 0) {
        log("Pokona≈Çe≈õ wszystkich przeciwnik√≥w!");
        // Boss daje wiƒôcej nagr√≥d
        money += currentEnemies.some(e => e.boss) ? 50 : 10;
        document.getElementById("money").innerText = money;
        document.getElementById("mainMoney").innerText = money;
        currentLevel++;    
        resetTeamHp();
        saveGame();
        document.getElementById("battleScreen").style.display = "none";
        document.getElementById("mainMenu").style.display = "block";
        return;
    }

    // --- Kontratak przeciwnik√≥w ---
    let target = playerTeam[Math.floor(Math.random() * playerTeam.length)];

currentEnemies.forEach(attacker => {
    if (!attacker) return;

    if (!attacker.stunned || attacker.stunned <= 0) {
        if (!target) return; // brak celu = koniec ataku
        target.hp = (Number(target.hp) || 0) - (Number(attacker.atk) || 0);

        if (target.hp <= 0) {
            log(`${target.name} poleg≈Ç i znika z dru≈ºyny!`);
            playerTeam = playerTeam.filter(p => p.hp > 0);

            // je≈ºeli wszyscy martwi ‚Üí przerwij
            if (playerTeam.length === 0) {
                log("Ca≈Ça dru≈ºyna zginƒô≈Ça!");
                return;
            }

            // wyb√≥r nowego celu
            target = playerTeam[Math.floor(Math.random() * playerTeam.length)];
        }
    } else {
        attacker.stunned--;
        log(`${attacker.name} jest og≈Çuszony i nie atakuje!`);
    }
});

    // --- Sprawdzenie przegranej ---
    if (playerTeam.every(p => p.hp <= 0)) {
        alert("Przegra≈Çe≈õ! Musisz powt√≥rzyƒá ten poziom.");
        resetTeamHp();
        loadGame();
        document.getElementById("battleScreen").style.display = "none";
        document.getElementById("mainMenu").style.display = "block";
        return;
    }

    renderStats();
    renderTargetSelect(); // od≈õwie≈ºenie select√≥w po turze
    saveGame();
}

    function log(msg) {
      document.getElementById("battleLog").innerHTML += msg + "<br>";
    }

    function openShop() {
      document.getElementById("mainMenu").style.display = "none";
      document.getElementById("shopScreen").style.display = "block";
      renderShop();
    }

    function closeShop() {
      document.getElementById("shopScreen").style.display = "none";
      document.getElementById("mainMenu").style.display = "block";
    }

function updateShop() {
  // losuj postaƒá
  shopOfferChar = shopCharacters[Math.floor(Math.random() * shopCharacters.length)];

  // losuj item
  shopOfferItem = shopItems[Math.floor(Math.random() * shopItems.length)];

  // losuj skin
  shopOfferSkin = shopSkins[Math.floor(Math.random() * shopSkins.length)];

  renderShop();
  setTimeout(updateShop, 600000); // co 10 minut reset
}

function buySkin() {
  const skin = shopOfferSkin;
  if (!skin) return;

  if (money < skin.cost) {
    alert("Za ma≈Ço kasy!");
    return;
  }

  // upewnij siƒô, ≈ºe mamy tablicƒô skin√≥w dla tej postaci
  if (!skins[skin.target]) skins[skin.target] = [];

  // sprawd≈∫, czy gracz ju≈º kupi≈Ç ten skin
  if (skins[skin.target].includes(skin.file)) {
    alert(`Masz ju≈º ten skin dla ${skin.target}!`);
    return;
  }

  // dodaj skin i odejmij pieniƒÖdze
  skins[skin.target].push(skin.file);
  money -= skin.cost;

  alert(`Kupi≈Çe≈õ ${skin.name} dla ${skin.target}!`);

  saveGame();
  renderShop();
}

function renderShop() {
  let charHTML = "";
  let itemHTML = "";
  let skinHTML = "";

  // üë§ Postaƒá w sklepie
  if (shopOfferChar) {
    charHTML = `<div class='card'><b>${shopOfferChar.name}</b><br>
      Atak: ${shopOfferChar.atk}<br>HP: ${shopOfferChar.hp}
      ${shopOfferChar.heal ? `<br>Leczy: ${shopOfferChar.heal} HP` : ""}
      <br>Koszt: ${shopOfferChar.cost} üíµ
      <br><button class='green' onclick='buyCharacter()'>Kup</button></div>`;
  }
  
  let slotHTML = `<div class='card'>
    <b>Ulepszenie slotu w dru≈ºynie</b><br>
    Koszt: ${slotUpgradeCost} üíµ<br>
    Aktualne sloty: ${teamSlots}<br>
    <button class='green' onclick='buyTeamSlot()'>Kup</button>
  </div>`;

  // üéÅ Item w sklepie
  if (shopOfferItem && !boughtItems.includes(shopOfferItem.name)) {
    itemHTML = `<div class='card'><b>${shopOfferItem.name}</b><br>
      Dla: ${shopOfferItem.target}<br>
      ${shopOfferItem.bonus?.atk ? `+${shopOfferItem.bonus.atk} DMG<br>` : ""}
      ${shopOfferItem.bonus?.hp ? `+${shopOfferItem.bonus.hp} HP<br>` : ""}
      ${shopOfferItem.bonus?.heal ? `+${shopOfferItem.bonus.heal} Leczenia<br>` : ""}
      Koszt: ${shopOfferItem.cost} üíµ
      <br><button class='green' onclick='buyItem()'>Kup</button></div>`;
  }

  // üé® Skin w sklepie
  if (shopOfferSkin) {
    skinHTML = `<div class='card'><b>${shopOfferSkin.name}</b><br>
      Skin dla: ${shopOfferSkin.target}<br>
      Koszt: ${shopOfferSkin.cost} üíµ
      <br><button class='green' onclick='buySkin()'>Kup</button></div>`;
  }

  document.getElementById("shopOffer").innerHTML = `
  <div style="display:flex; justify-content:center; gap:20px;">
    ${charHTML}${itemHTML}${skinHTML}${slotHTML}
  </div>`;

  document.getElementById("money").innerText = money;
}

function resetGame() {
  if (confirm("Na pewno chcesz zresetowaƒá ca≈ÇƒÖ grƒô?")) {
    localStorage.clear();
    playerTeam = [];
    money = 0;
    teamSlots = 3;
    currentLevel = 0;
    boughtItems = [];
    skins = {};
    document.getElementById("mainMoney").innerText = money;
    init(); 
    renderTeam();
    renderShop();
    alert("Gra zosta≈Ça zresetowana!");
  }
}

function buyItem() {
    if (money >= currentItem.price) {
        money -= currentItem.price;
        let target = team.find(p => p.name === currentItem.target);
        if (target) {
            for (let stat in currentItem.bonus) {
                target[stat] += currentItem.bonus[stat];
                if (stat === "hp") {
                    target.baseHp += currentItem.bonus[stat]; // üî• naprawa
                }
            }
        }
        currentItem = null;
        renderShop();
        renderTeam();
        updateStats();
    } else {
        alert("Za ma≈Ço monet!");
    }
}

function buyCharacter() {
  if (!shopOfferChar) return;

  if (money < shopOfferChar.cost) {
    alert("Za ma≈Ço kasy!");
    return;
  }

  // sprawdzamy czy ju≈º masz tƒô postaƒá
  if (
    availableCharacters.find(c => c.name === shopOfferChar.name) ||
    playerTeam.find(c => c.name === shopOfferChar.name)
  ) {
    alert("Masz ju≈º tƒô postaƒá i nie mo≈ºesz kupiƒá drugi raz!");
    return;
  }

  availableCharacters.push(shopOfferChar);
  money -= shopOfferChar.cost;
  document.getElementById("money").innerText = money;
  document.getElementById("mainMoney").innerText = money;
  alert(`Kupi≈Çe≈õ ${shopOfferChar.name}! Teraz mo≈ºesz jƒÖ za≈Ço≈ºyƒá w dru≈ºynie.`);
  
  saveGame();
  renderTeam();
  renderShop();
}

    init();
  </script>
</body>
</html>
